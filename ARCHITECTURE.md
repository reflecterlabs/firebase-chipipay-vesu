# Arquitectura de la IntegraciÃ³n

## ğŸ“Š Diagrama de Flujo de AutenticaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Usuario / Navegador                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Landing Page (/)    â”‚
                â”‚  - Check Auth State   â”‚
                â”‚  - Redirect           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â†“                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Authenticated       â”‚ Not Auth    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                       â”‚
                â†“                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Dashboard  â”‚       â”‚  Login/Register  â”‚
        â”‚  (SSR)      â”‚       â”‚  (CSR)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                       â”‚
                â”‚                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                   â†“             â†“
                â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚           â”‚Email/Pwd â”‚  â”‚ OAuth        â”‚
                â”‚           â”‚  Login   â”‚  â”‚ (GitHub/Ggl) â”‚
                â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                   â”‚             â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Supabase Auth      â”‚
                â”‚  - Session Managementâ”‚
                â”‚  - JWT Tokens        â”‚
                â”‚  - Encryption        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ Arquitectura de Capas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (Next.js)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Login Page   â”‚  â”‚   Dashboard  â”‚  â”‚ Other Pages              â”‚ â”‚
â”‚  â”‚ (CSR)        â”‚  â”‚   (SSR/CSR)  â”‚  â”‚                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ (HTTP/HTTPS)
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Backend/Middleware (Next.js API Routes)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Middleware                                                    â”‚  â”‚
â”‚  â”‚ - updateSession()                                             â”‚  â”‚
â”‚  â”‚ - Valida JWT                                                  â”‚  â”‚
â”‚  â”‚ - Maneja cookies                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Server Utils     â”‚  â”‚ Client Utils     â”‚  â”‚ Route Handlers  â”‚  â”‚
â”‚  â”‚ - getUser()      â”‚  â”‚ - createClient() â”‚  â”‚ - /auth/callbackâ”‚  â”‚
â”‚  â”‚ - SSR getters    â”‚  â”‚ - signUp()       â”‚  â”‚ - /api/*        â”‚  â”‚
â”‚  â”‚ - DB queries     â”‚  â”‚ - signIn()       â”‚  â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ (WebSockets/HTTP)
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase Backend                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Auth Service   â”‚  â”‚ Database (PG)  â”‚  â”‚ Real-time (WebSub) â”‚   â”‚
â”‚  â”‚ - OAuth        â”‚  â”‚ - user_profilesâ”‚  â”‚ - Session updates  â”‚   â”‚
â”‚  â”‚ - JWT          â”‚  â”‚ - transactions â”‚  â”‚ - Auth state       â”‚   â”‚
â”‚  â”‚ - Sessions     â”‚  â”‚ - user_metadataâ”‚  â”‚                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ (cuando se implemente ChipiPay)
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ChipiPay Integration                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ useCallAnyContract Hook                                       â”‚  â”‚
â”‚  â”‚ - Maneja transacciones gasless                                â”‚  â”‚
â”‚  â”‚ - InteractÃºa con Starknet                                     â”‚  â”‚
â”‚  â”‚ - Gestiona billing                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Vesu / Starknet                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ vTokens (USDC, WBTC, tBTC)                                   â”‚  â”‚
â”‚  â”‚ - Approve                                                    â”‚  â”‚
â”‚  â”‚ - Deposit                                                    â”‚  â”‚
â”‚  â”‚ - Withdraw                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Flujo de Seguridad

```
Request â†’ Middleware (updateSession) â†’ Valida JWT â†’ Parse Cookie
    â†“
Check RLS Policies (si aplica)
    â†“
Server/Client Function ejecuta
    â†“
Supabase retorna datos seguros (solo lo que el usuario puede ver)
    â†“
Response con headers de seguridad
    â†“
Frontend renderiza
```

## ğŸ“± Componentes Principales

```
useSupabaseAuth Hook
â”œâ”€â”€ user: User | null
â”œâ”€â”€ loading: boolean
â”œâ”€â”€ error: string | null
â”œâ”€â”€ signUp(email, password)
â”œâ”€â”€ signIn(email, password)
â”œâ”€â”€ signOut()
â””â”€â”€ signInWithOAuth(provider)

â†“

Supabase Client (utils/supabase/client.ts)
â”œâ”€â”€ auth.signUp()
â”œâ”€â”€ auth.signIn()
â”œâ”€â”€ auth.signOut()
â”œâ”€â”€ auth.getSession()
â”œâ”€â”€ auth.onAuthStateChange()
â””â”€â”€ from('table').select()

â†“

Supabase Server (utils/supabase/server.ts)
â”œâ”€â”€ auth.getUser()
â”œâ”€â”€ auth.getCookie()
â””â”€â”€ from('table').select() [SSR]
```

## ğŸ“Š Estado de la AplicaciÃ³n

```
Auth State Tree:
â”œâ”€â”€ user
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ email
â”‚   â”œâ”€â”€ user_metadata
â”‚   â””â”€â”€ created_at
â”œâ”€â”€ session
â”‚   â”œâ”€â”€ access_token (JWT)
â”‚   â”œâ”€â”€ refresh_token
â”‚   â””â”€â”€ expires_in
â””â”€â”€ isLoading (boolean)

UI State:
â”œâ”€â”€ page.tsx
â”‚   â”œâ”€â”€ loading (check auth)
â”‚   â””â”€â”€ routing (home â†’ login o dashboard)
â”œâ”€â”€ login/page.tsx
â”‚   â”œâ”€â”€ email (input)
â”‚   â”œâ”€â”€ password (input)
â”‚   â”œâ”€â”€ isSignUp (toggle)
â”‚   â”œâ”€â”€ loading (submit)
â”‚   â””â”€â”€ error (display)
â””â”€â”€ dashboard/page.tsx
    â”œâ”€â”€ user info display
    â”œâ”€â”€ deposit form
    â””â”€â”€ transaction history
```

## ğŸ”„ Ciclo de Vida de SesiÃ³n

```
1. Usuario Accede a App
   â†“
2. Middleware Ejecuta updateSession()
   â†“
3. Middleware obtiene cookie de sesiÃ³n (si existe)
   â†“
4. Middleware intercambia cÃ³digo por sesiÃ³n (OAuth)
   â†“
5. Session se almacena en cookie segura
   â†“
6. Supabase Auth State se actualiza
   â†“
7. onAuthStateChange dispara listener
   â†“
8. Hook actualiza user state
   â†“
9. Componente re-renderiza con user data
   â†“
10. Si no autenticado â†’ Redirige a /login
    Si autenticado â†’ Muestra dashboard
```

## ğŸ¯ Flujo de IntegraciÃ³n con ChipiPay (Futuro)

```
Dashboard
    â”‚
    â”œâ”€ VesuDepositComponent
    â”‚  â”‚
    â”‚  â”œâ”€ useSupabaseAuth() [obtiene user]
    â”‚  â”‚
    â”‚  â”œâ”€ loadUserProfile() [obtiene starknet_address]
    â”‚  â”‚
    â”‚  â””â”€ useVesuSponsored() [setup transacciÃ³n]
    â”‚     â”‚
    â”‚     â””â”€ ChipiPay API
    â”‚        â”‚
    â”‚        â””â”€ Starknet Network
    â”‚           â”‚
    â”‚           â””â”€ Vesu vToken Contract
    â”‚              â”‚
    â”‚              â””â”€ Token Transfer
    â”‚                 â”‚
    â”‚                 â””â”€ Update en Supabase (transactions table)
    â”‚
    â””â”€ Success/Error Handling
```

## ğŸ“ˆ Escalabilidad

```
Nivel 1: AutenticaciÃ³n bÃ¡sica
â”œâ”€â”€ Email/ContraseÃ±a âœ…
â”œâ”€â”€ OAuth âœ…
â””â”€â”€ Session Management âœ…

Nivel 2: IntegraciÃ³n ChipiPay
â”œâ”€â”€ Vincular direcciÃ³n Starknet
â”œâ”€â”€ Billeteras de ChipiPay
â””â”€â”€ Transacciones gasless

Nivel 3: CaracterÃ­sticas Avanzadas
â”œâ”€â”€ Historial de transacciones
â”œâ”€â”€ Analytics
â”œâ”€â”€ Multi-firma
â””â”€â”€ Governance
```

---

**Nota:** Esta arquitectura estÃ¡ lista para soportar la integraciÃ³n completa con ChipiPay y Vesu en los prÃ³ximos pasos.
